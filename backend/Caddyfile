# Caddyfile untuk Tunlify Backend

# Frontend website
tunlify.biz.id {
	reverse_proxy localhost:3000

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Gzip compression
	encode gzip

	# Logs
	log {
		output file /var/log/caddy/tunlify-frontend.log
		format json
	}
}

# Backend API
api.tunlify.biz.id {
	reverse_proxy localhost:3001

	# CORS headers
	header {
		Access-Control-Allow-Origin "https://tunlify.biz.id"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
		Access-Control-Allow-Credentials "true"
	}

	# Handle preflight requests
	@options method OPTIONS
	respond @options 200

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
	}

	# Logs
	log {
		output file /var/log/caddy/tunlify-api.log
		format json
	}
}

# Wildcard untuk tunnel subdomains
*.id.tunlify.biz.id {
	# Extract subdomain
	@tunnel expression {labels.3} != ""

	# Reverse proxy ke backend untuk mendapatkan target
	reverse_proxy @tunnel localhost:3001 {
		header_up X-Tunnel-Subdomain {labels.3}
		header_up X-Tunnel-Region "id"
	}

	# Logs
	log {
		output file /var/log/caddy/tunlify-tunnels-id.log
		format json
	}
}

# Wildcard untuk region lain (contoh: Singapore)
*.sg.tunlify.biz.id {
	@tunnel expression {labels.3} != ""

	reverse_proxy @tunnel localhost:3001 {
		header_up X-Tunnel-Subdomain {labels.3}
		header_up X-Tunnel-Region "sg"
	}

	log {
		output file /var/log/caddy/tunlify-tunnels-sg.log
		format json
	}
}

# Wildcard untuk region US
*.us.tunlify.biz.id {
	@tunnel expression {labels.3} != ""

	reverse_proxy @tunnel localhost:3001 {
		header_up X-Tunnel-Subdomain {labels.3}
		header_up X-Tunnel-Region "us"
	}

	log {
		output file /var/log/caddy/tunlify-tunnels-us.log
		format json
	}
}

# Wildcard untuk region Germany
*.de.tunlify.biz.id {
	@tunnel expression {labels.3} != ""

	reverse_proxy @tunnel localhost:3001 {
		header_up X-Tunnel-Subdomain {labels.3}
		header_up X-Tunnel-Region "de"
	}

	log {
		output file /var/log/caddy/tunlify-tunnels-de.log
		format json
	}
}

# Wildcard untuk region Japan
*.jp.tunlify.biz.id {
	@tunnel expression {labels.3} != ""

	reverse_proxy @tunnel localhost:3001 {
		header_up X-Tunnel-Subdomain {labels.3}
		header_up X-Tunnel-Region "jp"
	}

	log {
		output file /var/log/caddy/tunlify-tunnels-jp.log
		format json
	}
}
